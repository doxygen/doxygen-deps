name: Build Doxygen

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  BUILD_TYPE: Release

jobs:
  build-doxygen:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
            extension: ""
            archive_format: tar.gz
          - os: windows-latest
            platform: windows
            extension: .exe
            archive_format: zip
          - os: macos-15
            platform: macos
            extension: ""
            archive_format: tar.gz
          - os: macos-15-intel
            platform: macos
            extension: ""
            archive_format: tar.gz
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          zlib1g-dev \
          libedit-dev \
          libffi-dev \
          libxml2-dev \
          libtinfo-dev \
          flex \
          bison \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-dev \
          libx11-xcb-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libxcb-cursor-dev \
          libxcb-glx0-dev \
          libxcb-keysyms1-dev \
          libxcb-image0-dev \
          libxcb-shm0-dev \
          libxcb-icccm4-dev \
          libxcb-sync-dev \
          libxcb-xfixes0-dev \
          libxcb-shape0-dev \
          libxcb-randr0-dev \
          libxcb-render-util0-dev \
          libxcb-util-dev \
          libxcb-xinerama0-dev \
          libxcb-xkb-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          uuid-dev
      shell: bash

    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        choco install ninja winflexbison3
      shell: bash

    - name: Install dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        brew install cmake ninja flex bison ossp-uuid
        # make sure flex and bison from brew are found and not the one from the system.
        echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
        echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
        echo "LOC=$(brew --prefix ossp-uuid)"
      shell: bash

    - name: Set up MSVC dev command prompt (Windows)
      if: matrix.platform == 'windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Download zlib (Windows)
      if: matrix.platform == 'windows'
      run: |
        curl -L -o zlib.tgz https://zlib.net/zlib-1.3.1.tar.gz
        tar zxvf zlib.tgz
    
    - name: Build zlib (Windows)
      if: matrix.platform == 'windows'
      shell: cmd
      run: |
        cd zlib-1.3.1
        @rem nmake -f win32\Makefile.msc LOC="-MT" all
        nmake -f win32\Makefile.msc LOC="-MT" zlib.lib

    - name: Get latest Doxygen release tag
      id: doxygen-version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        echo "GITHUB_TOKEN present: ${GITHUB_TOKEN:+yes}"
        # Retry loop with exponential backoff
        attempts=5
        sleep_for=2
        for i in $(seq 1 $attempts); do
          echo "Attempt $i..."
          resp=$(curl -sS -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/doxygen/doxygen/releases/latest" ) || true
          http_code=$(echo "$resp" | jq -r '. | if has("message") then "error" else "ok" end')
          tag=$(echo "$resp" | jq -r '.tag_name // empty')
          if [ -n "$tag" ]; then
            LATEST_TAG="$tag"
            break
          fi
          echo "No tag found. API response (truncated):"
          echo "$resp" | jq -C '.' | sed -n '1,200p'
          echo "Sleeping $sleep_for seconds before retry..."
          sleep $sleep_for
          sleep_for=$((sleep_for * 2))
        done

        if [ -z "${LATEST_TAG:-}" ]; then
          echo "Error: Could not fetch Doxygen release tag; last response:"
          echo "$resp" | jq -C '.' || echo "$resp"
          exit 1
        fi

        echo "Latest Doxygen release: $LATEST_TAG"
        echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        # Remove leading 'Release_' prefix if present
        VERSION=${LATEST_TAG#Release_}
        VERSION=${VERSION//_/.}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
      shell: bash

    #- name: Cache Doxygen source
    #  id: cache-doxygen-source
    #  uses: actions/cache@v4
    #  with:
    #    path: doxygen
    #    key: doxygen-source-${{ steps.doxygen-version.outputs.tag }}-${{ matrix.os }}

    - name: Download Doxygen source code
      #if: steps.cache-doxygen-source.outputs.cache-hit != 'true'
      run: |
        echo "Downloading Doxygen ${{ steps.doxygen-version.outputs.tag }}"
        #git clone --depth 1 --branch ${{ steps.doxygen-version.outputs.tag }} https://github.com/doxygen/doxygen.git
        git clone --depth 1 --branch master https://github.com/doxygen/doxygen.git
        if [ ! -d "doxygen" ]; then
          echo "Error: Doxygen source download failed or directory structure is incorrect"
          exit 1
        fi
        echo "Doxygen source downloaded successfully"
      shell: bash

    - name: Download LLVM artifacts
      uses: dawidd6/action-download-artifact@v6
      with:
        workflow: build-llvm.yml
        name: llvm-static-.*-${{ matrix.os }}
        name_is_regexp: true
        path: llvm-artifact
        skip_unpack: false

    - name: Extract LLVM version from artifact
      id: llvm-version
      run: |
        cd llvm-artifact
        FILENAME=$(ls llvm-static-* | head -1)
        VERSION=$(echo "$FILENAME" | sed -E 's/llvm-static-(.+)-${{ matrix.os }}.*/\1/')        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "LLVM version from artifact: $VERSION"
      shell: bash

    - name: Download Qt6 artifacts
      uses: dawidd6/action-download-artifact@v6
      with:
        workflow: build-qt6.yml
        name: qt6-static-.*-${{ matrix.os }}
        name_is_regexp: true
        path: qt6-artifact
        skip_unpack: false

    - name: Extract Qt6 version from artifact
      id: qt6-version
      run: |
        cd qt6-artifact
        FILENAME=$(ls qt6-static-* | head -1)
        VERSION=$(echo "$FILENAME" | sed -E 's/qt6-static-(.+)-${{ matrix.os }}.*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Qt6 version from artifact: $VERSION"
      shell: bash

    - name: Download Xapian artifacts
      uses: dawidd6/action-download-artifact@v6
      with:
        workflow: build-xapian.yml
        name: xapian-static-.*-${{ matrix.os }}
        name_is_regexp: true
        path: xapian-artifact
        skip_unpack: false

    - name: Extract Xapian version from artifact
      id: xapian-version
      run: |
        cd xapian-artifact
        FILENAME=$(ls xapian-static-* | head -1)
        VERSION=$(echo "$FILENAME" | sed -E 's/xapian-static-(.+)-${{ matrix.os }}.*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Xapian version from artifact: $VERSION"
      shell: bash

    - name: Extract LLVM artifacts (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        mkdir -p llvm-install
        cd llvm-artifact/llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}
        # Extract the tar.gz archive to the install directory
        tar -xzf llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}.tar.gz -C ../../llvm-install
      shell: bash

    - name: Extract LLVM artifacts (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir llvm-install
        dir
        cd llvm-artifact\llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}
        dir
        # Extract the zip archive to the install directory
        Expand-Archive -Path "llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}.zip" -DestinationPath "../../llvm-install"
      shell: pwsh

    - name: Extract Qt6 artifacts (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        mkdir -p qt6-install
        cd qt6-artifact/qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}
        # Extract the tar.gz archive to the install directory
        tar -xzf qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}.tar.gz -C ../../qt6-install
      shell: bash

    - name: Extract Qt6 artifacts (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir qt6-install
        cd qt6-artifact\qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}
        # Extract the zip archive to the install directory
        Expand-Archive -Path "qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}.zip" -DestinationPath "../../qt6-install"
      shell: pwsh

    - name: Extract Xapian artifacts (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        mkdir -p xapian-install
        cd xapian-artifact/xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}
        # Extract the tar.gz archive to the install directory
        tar -xzf xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.tar.gz -C ../../xapian-install
      shell: bash

    - name: Extract Xapian artifacts (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir xapian-install
        cd xapian-artifact\xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}
        # Extract the zip archive to the install directory
        Expand-Archive -Path "xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.zip" -DestinationPath "../../xapian-install"
      shell: pwsh

    - name: Configure CMake for Doxygen (Linux)
      if: matrix.platform == 'linux'
      run: |
        mkdir -p doxygen/build
        cd doxygen/build
        UUID_FLAG="-DUUID_LIB=/lib/x86_64-linux-gnu/libuuid.a"
        echo "UUID_FLAG=$UUID_FLAG"
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" \
          -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/doxygen-install" \
          -DXAPIAN_LIBRARIES="${{ github.workspace }}/xapian-install/lib/libxapian.a" \
          -DXAPIAN_INCLUDE_DIR="${{ github.workspace }}/xapian-install/include" \
          -DXAPIAN_DIR="${{ github.workspace }}/xapian-install/lib/cmake/xapian" $UUID_FLAG \
          -DLLVM_DIR="${{ github.workspace }}/llvm-install/lib/cmake/llvm" \
          -DClang_DIR="${{ github.workspace }}/llvm-install/lib/cmake/clang" \
          -DQt6_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6" \
          -DQt6Core_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Core" \
          -DQt6Gui_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Gui" \
          -DQt6Widgets_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Widgets" \
          -Dbuild_search=YES \
          -Dbuild_wizard=YES \
          -Duse_libclang=YES \
          -Dstatic_libclang=YES \
          -Dstatic_libxapian=YES \
          -Dforce_qt=Qt6 \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/llvm-install;${{ github.workspace }}/qt6-install;${{ github.workspace }}/xapian-install"
        echo "=== done ==="
        make -j$(nproc)
        make install
      shell: bash

    - name: Configure CMake for Doxygen (macOS)
      if: matrix.platform == 'macos'
      run: |
        mkdir -p doxygen/build
        cd doxygen/build
        UUID_FLAG="-DUUID_LIB=$(brew --prefix ossp-uuid)/lib/libuuid.a"
        echo "UUID_FLAG=$UUID_FLAG"
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" \
          -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/doxygen-install" \
          -DXAPIAN_LIBRARIES="${{ github.workspace }}/xapian-install/lib/libxapian.a" \
          -DXAPIAN_INCLUDE_DIR="${{ github.workspace }}/xapian-install/include" \
          -DXAPIAN_DIR="${{ github.workspace }}/xapian-install/lib/cmake/xapian" $UUID_FLAG \
          -DLLVM_DIR="${{ github.workspace }}/llvm-install/lib/cmake/llvm" \
          -DClang_DIR="${{ github.workspace }}/llvm-install/lib/cmake/clang" \
          -DQt6_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6" \
          -DQt6Core_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Core" \
          -DQt6Gui_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Gui" \
          -DQt6Widgets_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Widgets" \
          -Dbuild_search=YES \
          -Dbuild_wizard=YES \
          -Duse_libclang=YES \
          -Dstatic_libclang=YES \
          -Dstatic_libxapian=YES \
          -Dforce_qt=Qt6 \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/llvm-install;${{ github.workspace }}/qt6-install;${{ github.workspace }}/xapian-install"
        echo "=== done ==="
        make -j$(sysctl -n hw.logicalcpu)
        make install
      shell: bash      

    - name: Configure CMake for Doxygen (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir doxygen\build
        cd doxygen\build
        cmake .. -G "Ninja" -Dwin_static=YES -Dbuild_search=YES -Dbuild_wizard=YES -Duse_libclang=YES -Dstatic_libclang=YES -Dforce_qt=Qt6 ^
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
              -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}\doxygen-install ^
              -DXAPIAN_LIBRARIES=${{ github.workspace }}\xapian-install\lib\xapian.lib ^
              -DXAPIAN_INCLUDE_DIR=${{ github.workspace }}\xapian-install\include ^
              -DXAPIAN_DIR=${{ github.workspace }}\xapian-install\lib\cmake\xapian ^
              -DLLVM_DIR=${{ github.workspace }}\llvm-install\lib\cmake\llvm ^
              -DClang_DIR=${{ github.workspace }}\llvm-install\lib\cmake\clang ^
              -DCLANG_LIBS=${{ github.workspace }}\llvm-install\lib\libclang.lib ^
              -DQt6_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6 ^
              -DQt6Core_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6Core ^
              -DQt6Gui_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6Gui ^
              -DQt6Widgets_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6Widgets ^
              -DZLIB_LIBRARY=${{ github.workspace }}\zlib-1.3.1\zlib.lib ^
              -DZLIB_INCLUDE_DIR=${{ github.workspace }}\zlib-1.3.1\include
        cmake --build . --parallel
        cmake --install .
      shell: cmd

    - name: Verify Doxygen build (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        echo "Checking Doxygen binary..."
        ls -lh ${{ github.workspace }}/doxygen-install/bin/doxygen${{ matrix.extension }}        
        # Try to run doxygen to verify it works
        ${{ github.workspace }}/doxygen-install/bin/doxygen${{ matrix.extension }} --version || echo "Note: doxygen version check failed (may be expected on some platforms)"
      shell: bash

    - name: Verify Doxygen build (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo "Checking Doxygen binary..."
        ls -lh ${{ github.workspace }}\doxygen-install\bin\doxygen${{ matrix.extension }}
        ${{ github.workspace }}\doxygen-install\bin\doxygen${{ matrix.extension }} --version || echo "Note: doxygen version check failed (may be expected on some platforms)"
      shell: cmd      

    - name: Prepare binaries (Windows)
      if: matrix.platform == 'windows'
      run: |      
        copy ${{ github.workspace }}\llvm-install\bin\libclang.dll ${{ github.workspace }}\doxygen-install\bin
        editbin ${{ github.workspace }}\doxygen-install\bin\doxygen.exe /SUBSYSTEM:CONSOLE,6.00 /OSVERSION:5.1
        editbin ${{ github.workspace }}\doxygen-install\bin\doxyindexer.exe /SUBSYSTEM:CONSOLE,6.00 /OSVERSION:5.1
        editbin ${{ github.workspace }}\doxygen-install\bin\doxysearch.cgi.exe /SUBSYSTEM:CONSOLE,6.00 /OSVERSION:5.1        
      shell: cmd
      
    - name: Create build artifact (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        cd ${{ github.workspace }}
        tar -czf doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.os }}.tar.gz -C doxygen-install .
      shell: bash
      
    - name: Create build artifact (Windows)
      if: matrix.platform == 'windows'
      run: |
        Compress-Archive -Path 'doxygen-install\\*' -DestinationPath 'doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.os }}.zip' -Force
      shell: pwsh
      
    - name: Upload Doxygen build
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.os }}
        path: doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.os }}.${{ matrix.archive_format }}
        retention-days: 30

    - name: Display build summary
      run: |
        echo "## Doxygen Build Summary (${{ matrix.platform }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
        echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Doxygen Version**: ${{ steps.doxygen-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: ${{ env.BUILD_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **LLVM Version**: ${{ steps.llvm-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Qt6 Version**: ${{ steps.qt6-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Xapian Version**: ${{ steps.xapian-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Archive Format**: ${{ matrix.archive_format }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### CMake Configuration" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "-Dbuild_doc=YES" >> $GITHUB_STEP_SUMMARY
        echo "-Dbuild_search=YES" >> $GITHUB_STEP_SUMMARY
        echo "-Dbuild_wizard=YES" >> $GITHUB_STEP_SUMMARY
        echo "-Dbuild_app=YES" >> $GITHUB_STEP_SUMMARY
        echo "-Dbuild_parse=YES" >> $GITHUB_STEP_SUMMARY
        echo "-Duse_libclang=YES" >> $GITHUB_STEP_SUMMARY
        echo "-Dstatic_libclang=YES" >> $GITHUB_STEP_SUMMARY
        echo "-Dforce_qt=Qt6" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installed Components" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find ${{ github.workspace }}/doxygen-install/bin -type f -executable 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      shell: bash
